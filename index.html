<script>

let masterSheet="1sj8M7tQWFXXuk0IdVu7myTrjCTp0kOcqreBk9PUlKKQ";
let brandList=[];
let all=[];

/* Load Brand List */
fetch("https://opensheet.elk.sh/"+masterSheet+"/Sheet1")
.then(r=>r.json())
.then(d=>{
  brandList=d;
  makeButtons();
});

function makeButtons(){
  let html="";
  brandList.forEach(b=>{
    let name=b["Brand"];
    let id=b["SheetID"];
    if(!name||!id) return;

    html+=`<span class="brandBtn" onclick="loadBrand('${id}',this)">${name}</span>`;
  });

  document.getElementById("brands").innerHTML=html;

  let first=brandList[0]["SheetID"];
  loadBrand(first,document.querySelector(".brandBtn"));
}

/* MULTI SHEET LOAD */
function loadBrand(sheetIDs,btn){

  document.querySelectorAll(".brandBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");

  document.getElementById("data").innerHTML='<div class="loading">Loading...</div>';

  let ids = sheetIDs.split(",").map(x=>x.trim());
  let promises = ids.map(id =>
    fetch("https://opensheet.elk.sh/"+id+"/Sheet1")
    .then(r=>r.json())
  );

  Promise.all(promises).then(results=>{

    let merged=[];
    results.forEach(d=>{
      let clean=d.filter(x=>x["Model"] && x["Model"]!="Model");
      merged = merged.concat(clean);
    });

    all=merged;
    show(all);
    document.getElementById("count").innerText="Total Models: "+all.length;

  });

}

/* SMART BOX DETECT */
function getBox(x){
  return x["Box"] || x["BOX"] || x["box"] || x[Object.keys(x)[2]] || "";
}

function formatPrice(p){
  if(!p) return '<span class="ask">ASK</span>';

  let t=p.toString().toUpperCase();
  t=t.replace(/OLED/g,'<span class="oled">OLED</span>');
  t=t.replace(/COPY/g,'<span class="copy">COPY</span>');
  t=t.replace(/STOCK OUT/g,'<span class="out">STOCK OUT</span>');
  t=t.replace(/\n/g,"<br>");
  return t;
}

function show(d){
  let html="";
  d.forEach(x=>{
    let model=x["Model"]||"";
    let price=x["Price"]||"";
    let box=getBox(x);

    html+=`
    <div class="card">
      <div class="model">${model}</div>
      <div class="pricebox">${formatPrice(price)}</div>
      ${box? `<span class="box">${box}</span>`:""}
    </div>`;
  });

  document.getElementById("data").innerHTML=html;
}

function search(){
  let s=document.getElementById("search").value.toLowerCase();
  let f=all.filter(x=>
    (x["Model"]+"").toLowerCase().includes(s)
  );
  show(f);
}

</script>
